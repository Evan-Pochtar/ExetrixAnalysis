<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Performance Profile Report - {{ report.meta.language }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="report.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Performance Profile Report</h1>
        <div class="subtitle">
          Comprehensive performance analysis of your {{ report.meta.language }}
          application
          <span class="language-badge">{{ report.meta.language }}</span>
        </div>
      </header>

      <div class="stats-grid">
        <div class="metric">
          <span id="metric-wall-time" class="metric-value">-</span>
          <span class="metric-label">Total Runtime</span>
          <div class="metric-subtitle">Wall clock time</div>
        </div>

        <div class="metric">
          <span id="metric-functions" class="metric-value">-</span>
          <span class="metric-label">Functions</span>
          <div class="metric-subtitle">User code functions</div>
        </div>

        <div class="metric">
          <span id="metric-calls" class="metric-value">-</span>
          <span class="metric-label">Total Calls</span>
          <div class="metric-subtitle">Function invocations</div>
        </div>

        <div class="metric">
          <span id="metric-peak-memory" class="metric-value">-</span>
          <span class="metric-label">Peak Memory</span>
          <div class="metric-subtitle">Traced allocations</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Function Performance</h2>
          </div>
          <div class="card-content">
            <table id="func-table">
              <thead>
                <tr>
                  <th data-key="total_time">
                    Total Time <span class="sort-indicator active">▼</span>
                  </th>
                  <th data-key="exclusive_time">
                    Exclusive <span class="sort-indicator">▼</span>
                  </th>
                  <th data-key="avg_time">
                    Average <span class="sort-indicator">▼</span>
                  </th>
                  <th data-key="call_count">
                    Calls <span class="sort-indicator">▼</span>
                  </th>
                  <th>Function</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div>
          <div class="card" style="margin-bottom: 24px">
            <div class="card-header">
              <h2 class="card-title">Memory Usage Timeline</h2>
            </div>
            <div class="card-content">
              <div class="chart-container">
                <div class="chart" id="memory-chart">
                  <div id="memory-chart-content"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom: 24px" id="cpu-card">
            <div class="card-header">
              <h2 class="card-title">CPU Usage Timeline</h2>
            </div>
            <div class="card-content">
              <div class="chart-container">
                <div class="chart" id="cpu-chart">
                  <div id="cpu-chart-content"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2 class="card-title">System Information</h2>
            </div>
            <div class="card-content">
              <div class="system-info">
                <div class="system-row">
                  <span class="system-label">Python Version:</span>
                  <span id="sys-python-version" class="system-value">-</span>
                </div>
                <div class="system-row">
                  <span class="system-label">Wall Time:</span>
                  <span id="sys-wall-time" class="system-value">-</span>
                </div>
                <div class="system-row">
                  <span class="system-label">CPU Time:</span>
                  <span id="sys-cpu-time" class="system-value">-</span>
                </div>
                <div class="system-row">
                  <span class="system-label">CPU Efficiency:</span>
                  <span id="sys-cpu-eff" class="system-value">-</span>
                </div>
                <div class="system-row">
                  <span class="system-label">Exit Code:</span>
                  <span id="sys-exit-code" class="system-value"
                    ><span id="exit-badge" class="badge">-</span></span
                  >
                </div>
                <div
                  class="system-row"
                  id="sys-cpu-cores-row"
                  style="display: none"
                >
                  <span class="system-label">CPU Cores:</span>
                  <span id="sys-cpu-cores" class="system-value">-</span>
                </div>
                <div
                  class="system-row"
                  id="sys-total-mem-row"
                  style="display: none"
                >
                  <span class="system-label">Total Memory:</span>
                  <span id="sys-total-mem" class="system-value">-</span>
                </div>
                <div
                  class="system-row"
                  id="sys-peak-rss-row"
                  style="display: none"
                >
                  <span class="system-label">Peak RSS:</span>
                  <span id="sys-peak-rss" class="system-value">-</span>
                </div>
                <div class="system-row" id="sys-gc-row" style="display: none">
                  <span class="system-label">GC Collections:</span>
                  <span id="sys-gc" class="system-value">-</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const report = {{ report | json_encode | safe }};

      function formatTime(seconds) {
        if (typeof seconds !== 'number') return 'N/A';
        if (seconds < 0.000001) return `${(seconds * 1e9).toFixed(0)}ns`;
        if (seconds < 0.001) return `${(seconds * 1e6).toFixed(0)}µs`;
        if (seconds < 1) return `${(seconds * 1e3).toFixed(1)}ms`;
        return `${seconds.toFixed(3)}s`;
      }

      function formatBytes(n) {
        if (typeof n !== 'number') return 'N/A';
        if (n < 1024) return `${n}B`;
        if (n < 1048576) return `${(n/1024).toFixed(1)}KB`;
        if (n < 1073741824) return `${(n/1048576).toFixed(1)}MB`;
        return `${(n/1073741824).toFixed(1)}GB`;
      }

      function comma(n){
        return (typeof n === 'number') ? n.toLocaleString() : String(n || '-');
      }

      document.getElementById('metric-wall-time').textContent = formatTime(report.meta.wall_time_s);
      document.getElementById('metric-functions').textContent = comma(report.summary.total_functions);
      document.getElementById('metric-calls').textContent = comma(report.summary.total_calls);
      document.getElementById('metric-peak-memory').textContent = report.summary.peak_memory_tracemalloc ? formatBytes(report.summary.peak_memory_tracemalloc) : 'N/A';

      document.getElementById('sys-python-version').textContent = (report.meta.system_info && report.meta.system_info.python_version) ? report.meta.system_info.python_version : 'Unknown';
      document.getElementById('sys-wall-time').textContent = formatTime(report.meta.wall_time_s);
      document.getElementById('sys-cpu-time').textContent = formatTime(report.meta.cpu_time_s);
      document.getElementById('sys-cpu-eff').textContent = (report.meta.wall_time_s > 0 && report.meta.cpu_time_s) ? ((report.meta.cpu_time_s / report.meta.wall_time_s * 100).toFixed(1) + '%') : 'N/A';
      const exitCode = report.meta.exit_code || 0;
      const exitBadge = document.getElementById('exit-badge');
      exitBadge.textContent = exitCode;
      exitBadge.className = `badge ${exitCode === 0 ? 'badge-success' : 'badge-error'}`;

      if (report.meta.system_info && report.meta.system_info.cpu_count) {
        document.getElementById('sys-cpu-cores').textContent = report.meta.system_info.cpu_count;
        document.getElementById('sys-cpu-cores-row').style.display = '';
      }
      if (report.meta.system_info && report.meta.system_info.total_memory) {
        document.getElementById('sys-total-mem').textContent = (report.meta.system_info.total_memory/1073741824).toFixed(1) + 'GB';
        document.getElementById('sys-total-mem-row').style.display = '';
      }
      if (report.peak_rss) {
        document.getElementById('sys-peak-rss').textContent = formatBytes(report.peak_rss);
        document.getElementById('sys-peak-rss-row').style.display = '';
      }
      if (report.summary && report.summary.total_gc_collections) {
        document.getElementById('sys-gc').textContent = report.summary.total_gc_collections;
        document.getElementById('sys-gc-row').style.display = '';
      }

      const tbody = document.querySelector("#func-table tbody");
      let nodes = (report.nodes || []).slice();
      let currentSort = { key: 'total_time', desc: true };

      function renderTable() {
        tbody.innerHTML = "";
        if (nodes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No functions profiled</td></tr>';
          return;
        }

        const maxTime = Math.max(...nodes.map(n => n.total_time), 1e-9);
        const displayNodes = nodes.slice(0, 50);

        displayNodes.forEach(n => {
          const tr = document.createElement("tr");
          const barWidth = Math.max(3, Math.round((n.total_time / maxTime) * 250));
          tr.innerHTML = `
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                <div class="time-bar" style="width: ${barWidth}px;"></div>
                <span style="font-weight: 600;">${formatTime(n.total_time)}</span>
              </div>
            </td>
            <td style="font-weight: 500;">${formatTime(n.exclusive_time)}</td>
            <td style="color: #8b5cf6; font-weight: 500;">${formatTime(n.avg_time)}</td>
            <td style="font-weight: 600; color: #3b82f6;">${comma(n.call_count)}</td>
            <td><div class="function-name" title="${n.id}">${n.id}</div></td>
          `;
          tbody.appendChild(tr);
        });

        if (nodes.length > 50) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px; color: #64748b; font-style: italic;">Showing top 50 of ${nodes.length} functions</td>`;
          tbody.appendChild(tr);
        }
      }

      function sortBy(key, desc = false) {
        currentSort = { key, desc };
        nodes.sort((a, b) => {
          const aVal = a[key] || 0;
          const bVal = b[key] || 0;
          if (aVal === bVal) return 0;
          return (aVal < bVal ? -1 : 1) * (desc ? -1 : 1);
        });

        document.querySelectorAll('.sort-indicator').forEach(ind => { ind.classList.remove('active'); ind.textContent = '▼'; });
        const activeHeader = document.querySelector(`th[data-key="${key}"] .sort-indicator`);
        if (activeHeader) {
          activeHeader.classList.add('active');
          activeHeader.textContent = desc ? '▼' : '▲';
        }
        renderTable();
      }

      document.querySelectorAll("#func-table th[data-key]").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          const desc = currentSort.key === key ? !currentSort.desc : true;
          sortBy(key, desc);
        });
      });

      renderTable();

      function renderMemoryTimeline() {
        const container = document.getElementById('memory-chart-content');
        const samples = report.memory_samples || [];
        if (!samples.length) {
          container.innerHTML = '<div class="empty-state">No memory samples recorded</div>';
          return;
        }
        const maxPeak = Math.max(...samples.map(s => s.peak || 0), 1);
        const step = Math.max(1, Math.floor(samples.length / 40));
        const out = [];
        for (let i = 0; i < samples.length; i += step) {
          const s = samples[i];
          const w = Math.round(( (s.peak || 0) / maxPeak) * 100);
          out.push(`<div class="timeline-item">
            <div class="timeline-time">${(s.t||0).toFixed(1)}s</div>
            <div class="timeline-bar-container"><div class="memory-bar" style="width:${w}%;"></div></div>
            <div class="timeline-value">${formatBytes(s.peak||0)}</div>
          </div>`);
        }
        container.innerHTML = out.join('');
      }

      function renderCpuTimeline() {
        const container = document.getElementById('cpu-chart-content');
        const samples = report.cpu_samples || [];
        if (!samples.length) {
          document.getElementById('cpu-card').style.display = 'none';
          return;
        }
        const maxCpu = Math.max(...samples.map(s => s.cpu_percent || 0), 1);
        const step = Math.max(1, Math.floor(samples.length / 40));
        const out = [];
        for (let i = 0; i < samples.length; i += step) {
          const s = samples[i];
          const w = Math.round(((s.cpu_percent||0) / maxCpu) * 100);
          out.push(`<div class="timeline-item">
            <div class="timeline-time">${(s.t||0).toFixed(1)}s</div>
            <div class="timeline-bar-container"><div class="cpu-bar" style="width:${w}%;"></div></div>
            <div class="timeline-value">${(s.cpu_percent||0).toFixed(1)}%</div>
          </div>`);
        }
        container.innerHTML = out.join('');
      }

      renderMemoryTimeline();
      renderCpuTimeline();

      console.log('Performance report loaded:', {
        functions: nodes.length,
        totalCalls: report.summary.total_calls,
        runtime: `${report.meta.wall_time_s.toFixed(3)}s`,
        peakMemory: report.summary.peak_memory_tracemalloc ? formatBytes(report.summary.peak_memory_tracemalloc) : 'N/A'
      });
    </script>
  </body>
</html>
